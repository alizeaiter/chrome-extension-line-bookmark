"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function makeCounter(){var e=0;return function(){return e++}}function filterPins(){var e={};return pins.filter(function(t){return!e[t.Top()]&&(e[t.Top()]=!0)})}var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),b=document.documentElement,timer=void 0,timeOutRun=void 0,pins=[],scrolls=[],filtered=void 0,alt=!1,id=makeCounter(),Pin=function(){function e(t,n,i,o){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";_classCallCheck(this,e),this.index=i,this.pin=document.createElement("div"),this.pin.style.left=t-9.5+"px",this.pin.style.top=n-20+"px",this.pin.classList.add("pin-line-bookmark"),this.pin.classList.add("bounceIn-line-bookmark"),this.pin.setAttribute("index",i),b.appendChild(this.pin),this.pin.addEventListener("click",this,!1),this.noteDiv=document.createElement("div"),this.noteDiv.classList.add("note-line-bookmark"),this.pin.appendChild(this.noteDiv),this.noteText=document.createElement("div"),this.noteText.classList.add("noteText-line-bookmark"),this.noteText.setAttribute("contenteditable","true"),this.noteText.setAttribute("placeholder","Write a note..."),this.noteText.innerHTML=r,this.noteText.addEventListener("keyup",this,!1),this.noteDiv.appendChild(this.noteText),this.top_scroll=o,this.x=t,this.y=n,this.note=r,this.scroll_from=!1}return _createClass(e,[{key:"handleEvent",value:function(e){switch(e.type){case"click":this.click(e);break;case"keyup":this.keyUp(e)}}},{key:"click",value:function(e){var t=this;alt===!1&&(this.noteDiv.classList.add("fadeInUp-line-bookmark"),this.noteDiv.classList.remove("fadeOutDown-line-bookmark")),this.noteText.addEventListener("focus",function(){t.noteText.parentElement.classList.add("hoverShadow-line-bookmark")}),this.noteText.addEventListener("blur",function(){t.noteText.parentElement.classList.remove("hoverShadow-line-bookmark")}),savePins()}},{key:"keyUp",value:function(e){var t=this;delay(function(){t.note=t.noteText.innerHTML,savePins()},1e3)}},{key:"Top",value:function(){return this.top_scroll}},{key:"X",value:function(){return this.x}},{key:"Y",value:function(){return this.y}},{key:"scrollFromPin",value:function(){this.scroll_from=!0}},{key:"removeScrollFromPin",value:function(){this.scroll_from=!1}},{key:"getScrollFrom",value:function(){return this.scroll_from}},{key:"removeElement",value:function(){this.pin.remove()}}]),e}();b.addEventListener("click",function(e){for(var t=e.pageX,n=e.pageY,i=!1,o=pins.length-1;o>=0;o--)if(pins[o]!=-1){var r=pins[o].X(),s=pins[o].Y(),a=Math.sqrt(Math.pow(Math.abs(t-r),2)+Math.pow(Math.abs(n-s),2));if(a<10){i=!0;break}}if(alt===!0)if(e.target.classList.contains("pin-line-bookmark"))e.target.classList.add("remove-pin-line-bookmark"),setTimeout(function(){for(var t=e.target.getAttribute("index"),n=void 0,i=pins.length-1;i>=0;i--)if(pins[i].index==t){n=i,pins.splice(i,1);break}e.target.remove();var o=(document.querySelectorAll(".pin-line-bookmark"),!1);for(i=0;i<pins.length;i++)if(1==pins[i].getScrollFrom()){o=!0;break}0==o&&(pins[n]?pins[n].scrollFromPin():pins[n-1]?pins[n-1].scrollFromPin():pins[n+1]?pins[n+1].scrollFromPin():pins=[]),filtered=filterPins(),savePins()},450);else if(0==i&&!e.target.classList.contains("noteText-line-bookmark")&&!e.target.classList.contains("note-line-bookmark")){var l=new Pin(t,n,id(),b.scrollTop);pins.push(l);for(var o=0;o<pins.length;o++)pins[o].Top()==pins[pins.length-1].Top()?pins[o].scrollFromPin():pins[o].removeScrollFromPin();sortPins(pins),filtered=filterPins(),savePins()}}),b.addEventListener("mouseup",function(e){if(!e.target.classList.contains("pin-line-bookmark")&&!e.target.classList.contains("note-line-bookmark")&&!e.target.classList.contains("noteText-line-bookmark"))for(var t=document.querySelectorAll(".note-line-bookmark"),n=0;n<t.length;n++){var i=t[n];i.classList.remove("fadeInUp-line-bookmark"),i.classList.add("fadeOutDown-line-bookmark")}});for(var reOrder=function(e){var t=0;for(t;t<e.length;t++)e[t].setAttribute("index",t)},noteText=document.querySelectorAll(".noteText-line-bookmark"),_loop=function(){var e=noteText[i];e.addEventListener("focus",function(){e.parentElement.classList.add("hoverShadow-line-bookmark")}),e.addEventListener("blur",function(){e.parentElement.classList.remove("hoverShadow-line-bookmark")})},i=0;i<noteText.length;i++)_loop();b.addEventListener("keyup",function(e){alt=!1}),b.addEventListener("keydown",function(e){if(1==e.altKey&&(alt=!0),88==e.keyCode&&1==e.ctrlKey&&"INPUT"!=e.target.tagName&&"TEXTAREA"!=e.target.tagName&&pins.length>0){for(var t=void 0,n=0;n<filtered.length;n++)if(1==filtered[n].getScrollFrom()){t=n;break}var i=void 0;for(i=0==t?filtered.length-1:t-1,b.scrollTop=filtered[i].Top(),n=0;n<pins.length;n++)pins[n].Top()==filtered[i].Top()?pins[n].scrollFromPin():pins[n].removeScrollFromPin()}});var sortPins=function(e){e.sort(function(e,t){return e.Top()-t.Top()})},delay=function(){var e=0;return function(t,n){clearTimeout(e),e=setTimeout(t,n)}}(),savePins=function(){localStorage.setItem(window.location.href,JSON.stringify(pins)),0===JSON.parse(localStorage.getItem(window.location.href)).length&&localStorage.removeItem(window.location.href)},storage=localStorage.getItem(window.location.href);if(null!==storage){storage=JSON.parse(storage);for(var i=0;i<storage.length;i++){var p=storage[i],pin=new Pin(p.x,p.y,id(),p.top_scroll,p.note);pin.scroll_from=p.scroll_from,pins.push(pin),filtered=filterPins()}}chrome.runtime.onMessage.addListener(function(e,t,n){var i=void 0;switch(i=null!==localStorage.getItem(window.location.href)?"full":"empty",e.type){case"getStatus":n(i);break;case"remove":removePins(),n("done");break;default:console.error("Unrecognised message: ",e)}});var removePins=function(){for(var e=0;e<pins.length;e++)pins[e].removeElement();pins=[],localStorage.removeItem(window.location.href)};